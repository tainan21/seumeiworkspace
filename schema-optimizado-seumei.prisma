// prisma/schema.prisma - Schema Otimizado SeuMei v2
// Multitenant, seguro, com audit trail e soft delete

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DB_PRISMA_URL")
  directUrl = env("DB_URL_NON_POOLING")
}

// ============================================================================
// CORE MODELS - Autenticação e Usuários
// ============================================================================

model User {
  id                     String                  @id @default(cuid())
  email                  String?                 @unique
  name                   String?
  avatarUrl              String?
  emailVerifiedAt        DateTime?
  status                 UserStatus              @default(ACTIVE)
  deletedAt              DateTime?               // Soft delete
  lastLoginAt            DateTime?
  
  // Stripe (apenas customer ID global)
  stripeCustomerId       String?                 @unique @map("stripe_customer_id")
  
  // GitHub OAuth
  githubId               Int?                    @unique
  
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  
  // Relations
  emailVerificationCodes EmailVerificationCode[]
  sessions               Session[]
  workspaceMemberships   WorkspaceMember[]
  auditLogs              AuditLog[]              @relation("AuditLogUser")
  notifications          Notification[]

  @@index([email])
  @@index([status])
  @@index([deletedAt])
  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  userAgent String?
  ipAddress String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

model EmailVerificationCode {
  id        String   @id @default(cuid())
  userId    String
  code      String   @unique
  email     String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
  @@index([expiresAt])
  @@map("email_verification_codes")
}

// ============================================================================
// WORKSPACE - Multitenant Core
// ============================================================================

model Workspace {
  id                 String             @id @default(cuid())
  name               String
  slug               String             @unique
  description        String?
  type               WorkspaceType      @default(SINGLE_BUSINESS)
  category           WorkspaceCategory  @default(LIVRE)
  status             WorkspaceStatus    @default(ACTIVE)
  logo               String?
  
  // Configuração genérica (versionada em ConfigHistory)
  settings           Json               @default("{}")
  
  // Matriz de empresa (para franquias)
  enterpriseMotherId String?            @unique
  
  // Soft delete
  deletedAt          DateTime?
  
  createdById        String
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  
  // Relations
  members            WorkspaceMember[]
  enterprises        Enterprise[]
  invites            WorkspaceInvite[]
  subscription       Subscription?
  wallet             Wallet?
  features           WorkspaceFeature[]
  themes             ThemeUI[]
  components         ComponentLayout[]
  moduleConfigs      ModuleConfig[]
  
  // Commercial
  customers          Customer[]
  products           Product[]
  categories         ProductCategory[]
  orders             Order[]
  quotes             Quote[]
  invoices           Invoice[]
  transactions       Transaction[]
  
  // Banking
  bankAccounts       BankAccount[]
  pixKeys            PixKey[]
  pixPayments        PixPayment[]
  dasPayments        DasPayment[]
  virtualAccounts    VirtualAccount[]
  paymentLinks       PaymentLink[]
  
  // Configuration
  dunningPolicies    DunningPolicy[]
  splitRules         SplitRule[]
  messageTemplates   MessageTemplate[]
  
  // Monitoring
  analytics          AnalyticsEvent[]
  auditLogs          AuditLog[]
  notifications      Notification[]
  configHistory      ConfigHistory[]
  
  // Relations
  enterpriseMother   Enterprise?        @relation("EnterpriseMother", fields: [enterpriseMotherId], references: [id])
  
  @@index([slug])
  @@index([status])
  @@index([type])
  @@index([category])
  @@index([deletedAt])
  @@map("workspaces")
}

model WorkspaceMember {
  id           String        @id @default(cuid())
  workspaceId  String
  userId       String
  role         WorkspaceRole @default(VIEWER)
  
  // Permissions customizadas (sobrescreve role default)
  permissions  String[]
  
  // Status
  isActive     Boolean       @default(true)
  joinedAt     DateTime      @default(now())
  lastActionAt DateTime?
  deletedAt    DateTime?     // Soft delete para auditoria
  
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@index([role])
  @@index([isActive])
  @@index([deletedAt])
  @@map("workspace_members")
}

model WorkspaceInvite {
  id          String        @id @default(cuid())
  workspaceId String
  email       String        @db.Citext
  role        WorkspaceRole @default(VIEWER)
  token       String        @unique
  expiresAt   DateTime
  acceptedAt  DateTime?
  revokedAt   DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, email])
  @@index([workspaceId])
  @@index([token])
  @@index([expiresAt])
  @@map("workspace_invites")
}

// ============================================================================
// ENTERPRISE - Estrutura de Negócios
// ============================================================================

model Enterprise {
  id                String                 @id @default(cuid())
  workspaceId       String
  
  // Tipo de negócio
  type              EnterpriseType
  legalName         String?
  tradeName         String
  document          String?                @unique
  documentType      EnterpriseDocumentType @default(NONE)
  
  // Classificação
  segment           String
  subSegment        String?
  
  // Status
  isMain            Boolean                @default(false)
  isActive          Boolean                @default(true)
  deletedAt         DateTime?              // Soft delete
  
  // Dados estruturados
  address           Json?                  // { street, number, complement, city, state, zipCode, country }
  contact           Json                   // { phone, email, website }
  
  createdById       String?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  
  // Relations
  workspace         Workspace              @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  themes            ThemeUI[]
  components        ComponentLayout[]
  meiProfile        MeiProfile?
  bankAccounts      BankAccount[]
  pixKeys           PixKey[]
  pixPayments       PixPayment[]
  dasPayments       DasPayment[]
  virtualAccounts   VirtualAccount[]
  splitRules        SplitRule[]
  
  // Commercial
  customers         Customer[]
  products          Product[]
  orders            Order[]
  quotes            Quote[]
  invoices          Invoice[]
  transactions      Transaction[]
  
  // MEI específico
  workspaceAsMother Workspace?             @relation("EnterpriseMother")

  @@index([workspaceId])
  @@index([document])
  @@index([type])
  @@index([isMain])
  @@index([isActive])
  @@index([deletedAt])
  @@map("enterprises")
}

model MeiProfile {
  id           String   @id @default(cuid())
  workspaceId  String
  enterpriseId String   @unique
  
  cnpj         String   @unique
  name         String
  email        String?
  phone        String?
  mainActivity String
  activities   String[]
  address      Json?    // { street, number, city, state, zipCode }
  
  isActive     Boolean  @default(true)
  deletedAt    DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([enterpriseId])
  @@index([cnpj])
  @@map("mei_profiles")
}

// ============================================================================
// SUBSCRIPTIONS & BILLING
// ============================================================================

model Subscription {
  id                   String             @id @default(cuid())
  workspaceId          String             @unique
  planId               String
  
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  
  // Stripe
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  
  // Soft delete
  deletedAt            DateTime?
  
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  
  plan                 Plan               @relation(fields: [planId], references: [id])
  workspace            Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([status])
  @@index([planId])
  @@index([deletedAt])
  @@map("subscriptions")
}

model Plan {
  id            String         @id @default(cuid())
  code          String         @unique
  name          String
  description   String?
  price         Decimal        @db.Decimal(15, 2)
  currency      String         @default("BRL")
  billingCycle  BillingCycle
  stripePriceId String?        @unique
  
  // Features incluídas (IDs de features)
  featureIds    String[]       @default([])
  limits        Json           @default("{}")   // { orders: 100, products: 50 }
  
  isActive      Boolean        @default(true)
  isPublic      Boolean        @default(true)
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  subscriptions Subscription[]

  @@index([code])
  @@index([isActive])
  @@map("plans")
}

// ============================================================================
// FEATURES & MODULES
// ============================================================================

model Feature {
  id                String             @id @default(cuid())
  code              String             @unique
  name              String
  category          FeatureCategory
  description       String?
  requiresPlan      WorkspacePlan?
  
  isActive          Boolean            @default(true)
  isPublic          Boolean            @default(false)
  isPremium         Boolean            @default(false)
  
  icon              String?
  version           String             @default("1.0.0")
  
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  workspaceFeatures WorkspaceFeature[]

  @@index([code])
  @@index([category])
  @@index([isActive])
  @@map("features")
}

model WorkspaceFeature {
  id          String        @id @default(cuid())
  workspaceId String
  featureId   String
  
  // Como a feature foi ativada
  source      FeatureSource
  
  // Status
  enabled     Boolean       @default(true)
  enabledAt   DateTime?
  expiresAt   DateTime?     // Para trial features
  
  // Configuração específica da feature
  config      Json          @default("{}")
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  feature     Feature       @relation(fields: [featureId], references: [id], onDelete: Cascade)
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, featureId])
  @@index([workspaceId])
  @@index([featureId])
  @@index([enabled])
  @@index([expiresAt])
  @@map("workspace_features")
}

model Module {
  id          String         @id @default(cuid())
  code        String         @unique
  name        String
  description String?
  category    ModuleCategory
  
  isActive    Boolean        @default(true)
  isCore      Boolean        @default(false)
  
  icon        String?
  version     String         @default("1.0.0")
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([code])
  @@index([category])
  @@index([isActive])
  @@map("modules")
}

model ModuleConfig {
  id          String   @id @default(cuid())
  workspaceId String
  moduleId    String
  
  config      Json     @default("{}")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([workspaceId, moduleId])
  @@index([workspaceId])
  @@index([moduleId])
  @@map("module_configs")
}

// ============================================================================
// PERMISSIONS & ROLES
// ============================================================================

model RolePermission {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  code        String   @unique
  description String?
  
  // JSON com lista de permissões { "create": true, "read": true, "update": false }
  permissions Json
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId])
  @@index([code])
  @@map("role_permissions")
}

// ============================================================================
// WALLET & TRANSACTIONS
// ============================================================================

model Wallet {
  id              String              @id @default(cuid())
  workspaceId     String              @unique
  
  balance         Decimal             @default(0) @db.Decimal(15, 2)
  reservedBalance Decimal             @default(0) @db.Decimal(15, 2)
  currency        String              @default("COIN")
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  transactions    WalletTransaction[]
  workspace       Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@map("wallets")
}

model WalletTransaction {
  id            String                @id @default(cuid())
  walletId      String
  
  type          WalletTransactionType
  amount        Decimal               @db.Decimal(15, 2)
  description   String
  
  referenceType String?               // "ORDER", "INVOICE", "PROMOTION"
  referenceId   String?
  
  metadata      Json?                 // Dados adicionais
  
  createdAt     DateTime              @default(now())
  
  wallet        Wallet                @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([type])
  @@index([createdAt])
  @@map("wallet_transactions")
}

// ============================================================================
// THEME & LAYOUT
// ============================================================================

model ThemeUI {
  id                 String      @id @default(cuid())
  workspaceId        String
  enterpriseId       String
  
  themeType          ThemeUIType
  themeName          String
  
  colors             Json        // { primary, secondary, accent, etc }
  typography         Json        // { fontFamily, fontSize, lineHeight, etc }
  layout             Json        // { spacing, borderRadius, etc }
  
  darkModeEnabled    Boolean     @default(false)
  
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  
  enterprise         Enterprise  @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)
  workspace          Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, enterpriseId])
  @@index([workspaceId])
  @@index([enterpriseId])
  @@map("theme_ui")
}

model ThemePreset {
  id          String             @id @default(cuid())
  code        String             @unique
  name        String
  description String?
  category    WorkspaceCategory?
  themeType   ThemeUIType
  
  colors      Json
  typography  Json
  layout      Json
  
  isActive    Boolean            @default(true)
  isPublic    Boolean            @default(true)
  isPremium   Boolean            @default(false)
  
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([code])
  @@index([category])
  @@index([isActive])
  @@map("theme_presets")
}

model ComponentLayout {
  id                 String     @id @default(cuid())
  workspaceId        String
  enterpriseId       String
  layoutVersion      Int        @default(1)
  
  components         Json       // Array de componentes e suas configurações
  
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  
  enterprise         Enterprise @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)
  workspace          Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, enterpriseId])
  @@index([workspaceId])
  @@index([enterpriseId])
  @@map("component_layouts")
}

// ============================================================================
// ONBOARDING
// ============================================================================

model OnboardingFlow {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  
  steps       Json     // Array de passos
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([isActive])
  @@map("onboarding_flows")
}

model OnboardingCompletion {
  id             String    @id @default(cuid())
  workspaceId    String    @unique
  flowId         String
  
  currentStep    Int       @default(0)
  completedSteps Json      @default("[]")    // Array de step IDs
  
  isCompleted    Boolean   @default(false)
  completedAt    DateTime?
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([workspaceId])
  @@index([flowId])
  @@index([isCompleted])
  @@map("onboarding_completions")
}

model OnboardingTemplate {
  id          String             @id @default(cuid())
  code        String             @unique
  name        String
  description String?
  category    WorkspaceCategory?
  
  steps       Json               // Template de passos
  config      Json               @default("{}")
  
  isActive    Boolean            @default(true)
  
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([code])
  @@index([category])
  @@index([isActive])
  @@map("onboarding_templates")
}

// ============================================================================
// COMMERCIAL - Clientes, Produtos, Pedidos
// ============================================================================

model Customer {
  id           String                @id @default(cuid())
  workspaceId  String
  enterpriseId String?
  
  name         String
  email        String?               @db.Citext
  phone        String?
  
  document     String?               @unique
  documentType CustomerDocumentType?
  
  address      Json?
  status       CustomerStatus        @default(ACTIVE)
  
  tags         String[]
  notes        String?
  
  deletedAt    DateTime?             // Soft delete
  
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  workspace    Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  enterprise   Enterprise?           @relation(fields: [enterpriseId], references: [id])

  @@index([workspaceId])
  @@index([enterpriseId])
  @@index([document])
  @@index([status])
  @@index([deletedAt])
  @@map("customers")
}

model ProductCategory {
  id          String   @id @default(cuid())
  workspaceId String
  
  name        String
  description String?
  parentId    String?  // Para subcategorias
  
  deletedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([parentId])
  @@index([deletedAt])
  @@map("product_categories")
}

model Product {
  id            String        @id @default(cuid())
  workspaceId   String
  enterpriseId  String?
  
  name          String
  sku           String?       @unique
  barcode       String?       @unique
  categoryId    String?
  
  price         Decimal       @db.Decimal(15, 2)
  costPrice     Decimal?      @db.Decimal(15, 2)
  
  trackStock    Boolean       @default(false)
  stockQuantity Decimal?      @db.Decimal(15, 2)
  
  description   String?
  images        String[]
  
  status        ProductStatus @default(ACTIVE)
  tags          String[]
  
  deletedAt     DateTime?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  workspace     Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  enterprise    Enterprise?   @relation(fields: [enterpriseId], references: [id])

  @@index([workspaceId])
  @@index([enterpriseId])
  @@index([categoryId])
  @@index([sku])
  @@index([status])
  @@index([deletedAt])
  @@map("products")
}

model Order {
  id            String        @id @default(cuid())
  workspaceId   String
  enterpriseId  String
  
  orderNumber   String        @unique
  customerId    String?
  
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  
  subtotal      Decimal       @db.Decimal(15, 2)
  discount      Decimal       @default(0) @db.Decimal(15, 2)
  tax           Decimal       @default(0) @db.Decimal(15, 2)
  total         Decimal       @db.Decimal(15, 2)
  
  notes         String?
  deletedAt     DateTime?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  items         OrderItem[]
  transactions  Transaction[]
  workspace     Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  enterprise    Enterprise    @relation(fields: [enterpriseId], references: [id])

  @@index([workspaceId])
  @@index([enterpriseId])
  @@index([customerId])
  @@index([status])
  @@index([orderNumber])
  @@index([deletedAt])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  productId String?
  
  name      String
  quantity  Decimal  @db.Decimal(15, 2)
  unitPrice Decimal  @db.Decimal(15, 2)
  discount  Decimal  @default(0) @db.Decimal(15, 2)
  total     Decimal  @db.Decimal(15, 2)
  
  createdAt DateTime @default(now())

  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Quote {
  id                 String      @id @default(cuid())
  workspaceId        String
  enterpriseId       String
  
  quoteNumber        String      @unique
  customerId         String?
  status             QuoteStatus @default(DRAFT)
  
  subtotal           Decimal     @db.Decimal(15, 2)
  discount           Decimal     @default(0) @db.Decimal(15, 2)
  tax                Decimal     @default(0) @db.Decimal(15, 2)
  total              Decimal     @db.Decimal(15, 2)
  
  validUntil         DateTime?
  convertedToOrderId String?     @unique
  deletedAt          DateTime?
  
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  items              QuoteItem[]
  workspace          Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  enterprise         Enterprise  @relation(fields: [enterpriseId], references: [id])

  @@index([workspaceId])
  @@index([enterpriseId])
  @@index([customerId])
  @@index([status])
  @@map("quotes")
}

model QuoteItem {
  id        String   @id @default(cuid())
  quoteId   String
  productId String?
  
  name      String
  quantity  Decimal  @db.Decimal(15, 2)
  unitPrice Decimal  @db.Decimal(15, 2)
  discount  Decimal  @default(0) @db.Decimal(15, 2)
  total     Decimal  @db.Decimal(15, 2)
  
  createdAt DateTime @default(now())

  quote     Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([productId])
  @@map("quote_items")
}

model Invoice {
  id            String        @id @default(cuid())
  workspaceId   String
  enterpriseId  String
  
  invoiceNumber String        @unique
  customerId    String?
  
  status        InvoiceStatus @default(DRAFT)
  
  subtotal      Decimal       @db.Decimal(15, 2)
  discount      Decimal       @default(0) @db.Decimal(15, 2)
  tax           Decimal       @default(0) @db.Decimal(15, 2)
  total         Decimal       @db.Decimal(15, 2)
  paidAmount    Decimal       @default(0) @db.Decimal(15, 2)
  
  issuedAt      DateTime
  dueDate       DateTime
  paidAt        DateTime?
  deletedAt     DateTime?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  items         InvoiceItem[]
  transactions  Transaction[]
  dunningJobs   DunningJob[]
  workspace     Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  enterprise    Enterprise    @relation(fields: [enterpriseId], references: [id])

  @@index([workspaceId])
  @@index([enterpriseId])
  @@index([customerId])
  @@index([status])
  @@index([invoiceNumber])
  @@index([dueDate])
  @@index([deletedAt])
  @@map("invoices")
}

model InvoiceItem {
  id        String   @id @default(cuid())
  invoiceId String
  productId String?
  
  name      String
  quantity  Decimal  @db.Decimal(15, 2)
  unitPrice Decimal  @db.Decimal(15, 2)
  discount  Decimal  @default(0) @db.Decimal(15, 2)
  total     Decimal  @db.Decimal(15, 2)
  
  createdAt DateTime @default(now())

  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([productId])
  @@map("invoice_items")
}

// ============================================================================
// TRANSACTIONS & PAYMENTS
// ============================================================================

model Transaction {
  id            String            @id @default(cuid())
  workspaceId   String
  enterpriseId  String?
  invoiceId     String?
  orderId       String?
  
  type          TransactionType
  amount        Decimal           @db.Decimal(15, 2)
  paymentMethod PaymentMethod
  status        TransactionStatus @default(PENDING)
  
  processedAt   DateTime?
  description   String?
  metadata      Json?             // Dados de processamento
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  workspace     Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  enterprise    Enterprise?       @relation(fields: [enterpriseId], references: [id])
  invoice       Invoice?          @relation(fields: [invoiceId], references: [id])
  order         Order?            @relation(fields: [orderId], references: [id])

  @@index([workspaceId])
  @@index([enterpriseId])
  @@index([invoiceId])
  @@index([orderId])
  @@index([type])
  @@index([status])
  @@index([paymentMethod])
  @@map("transactions")
}

// ============================================================================
// BANKING & PAYMENTS
// ============================================================================

model BankAccount {
  id             String          @id @default(cuid())
  workspaceId    String
  enterpriseId   String
  
  bankCode       String
  bankName       String
  agency         String
  account        String
  accountDigit   String
  accountType    BankAccountType
  
  holderName     String
  holderDocument String
  
  isActive       Boolean         @default(true)
  isDefault      Boolean         @default(false)
  deletedAt      DateTime?
  
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  workspace      Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  enterprise     Enterprise      @relation(fields: [enterpriseId], references: [id])

  @@index([workspaceId])
  @@index([enterpriseId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("bank_accounts")
}

model BankTransaction {
  id            String              @id @default(cuid())
  bankAccountId String
  
  type          BankTransactionType
  amount        Decimal             @db.Decimal(15, 2)
  description   String?
  
  date          DateTime
  postedAt      DateTime?
  balance       Decimal?            @db.Decimal(15, 2)
  
  externalId    String?             @unique
  
  createdAt     DateTime            @default(now())

  @@index([bankAccountId])
  @@index([type])
  @@index([date])
  @@index([externalId])
  @@map("bank_transactions")
}

model PixKey {
  id           String     @id @default(cuid())
  workspaceId  String
  enterpriseId String
  
  key          String     @unique
  keyType      PixKeyType
  
  isActive     Boolean    @default(true)
  deletedAt    DateTime?
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  workspace    Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id])

  @@index([workspaceId])
  @@index([enterpriseId])
  @@index([key])
  @@map("pix_keys")
}

model PixPayment {
  id           String           @id @default(cuid())
  workspaceId  String
  enterpriseId String?
  pixKeyId     String?
  
  amount       Decimal          @db.Decimal(15, 2)
  description  String?
  
  qrCode       String?
  qrCodeImage  String?
  
  status       PixPaymentStatus @default(PENDING)
  
  endToEndId   String?          @unique
  txId         String?          @unique
  
  expiresAt    DateTime?
  paidAt       DateTime?
  deletedAt    DateTime?
  
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  workspace    Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  enterprise   Enterprise?      @relation(fields: [enterpriseId], references: [id])

  @@index([workspaceId])
  @@index([pixKeyId])
  @@index([status])
  @@index([endToEndId])
  @@map("pix_payments")
}

model DasPayment {
  id              String           @id @default(cuid())
  workspaceId     String
  enterpriseId    String
  
  referenceNumber String           @unique
  period          String
  
  amount          Decimal          @db.Decimal(15, 2)
  principal       Decimal          @db.Decimal(15, 2)
  interest        Decimal          @default(0) @db.Decimal(15, 2)
  fine            Decimal          @default(0) @db.Decimal(15, 2)
  
  status          DasPaymentStatus @default(PENDING)
  
  dueDate         DateTime
  paidAt          DateTime?
  barcode         String?
  deletedAt       DateTime?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  workspace       Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  enterprise      Enterprise       @relation(fields: [enterpriseId], references: [id])

  @@index([workspaceId])
  @@index([enterpriseId])
  @@index([referenceNumber])
  @@index([status])
  @@index([dueDate])
  @@map("das_payments")
}

model PaymentLink {
  id                String            @id @default(cuid())
  workspaceId       String
  enterpriseId      String?
  
  code              String            @unique
  name              String
  description       String?
  
  amount            Decimal?          @db.Decimal(15, 2)
  allowCustomAmount Boolean           @default(false)
  
  paymentMethods    Json              @default("[]")
  
  maxUses           Int?
  expiresAt         DateTime?
  status            PaymentLinkStatus @default(ACTIVE)
  
  usesCount         Int               @default(0)
  deletedAt         DateTime?
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  workspace         Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  enterprise        Enterprise?       @relation(fields: [enterpriseId], references: [id])

  @@index([workspaceId])
  @@index([code])
  @@index([status])
  @@map("payment_links")
}

model VirtualAccount {
  id            String               @id @default(cuid())
  workspaceId   String
  enterpriseId  String?
  
  accountId     String               @unique
  accountNumber String               @unique
  
  bankCode      String
  bankName      String
  
  status        VirtualAccountStatus @default(ACTIVE)
  metadata      Json?
  
  deletedAt     DateTime?
  
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  workspace     Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  enterprise    Enterprise?          @relation(fields: [enterpriseId], references: [id])

  @@index([workspaceId])
  @@index([enterpriseId])
  @@index([accountId])
  @@index([status])
  @@map("virtual_accounts")
}

// ============================================================================
// SPLIT PAYMENTS & RECONCILIATION
// ============================================================================

model SplitRule {
  id           String   @id @default(cuid())
  workspaceId  String
  enterpriseId String?
  
  name         String
  description  String?
  
  // Condições para aplicar split { type: "order_value", condition: ">", value: 1000 }
  conditions   Json
  
  isActive     Boolean  @default(true)
  isDefault    Boolean  @default(false)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workspace    Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  enterprise   Enterprise?       @relation(fields: [enterpriseId], references: [id])
  allocations  SplitAllocation[]

  @@index([workspaceId])
  @@index([enterpriseId])
  @@index([isActive])
  @@map("split_rules")
}

model SplitAllocation {
  id             String              @id @default(cuid())
  ruleId         String
  
  recipientId    String              // PIX key, banco, etc
  recipientType  SplitRecipientType
  
  allocationType SplitAllocationType
  percentage     Decimal?            @db.Decimal(5, 2)
  fixedAmount    Decimal?            @db.Decimal(15, 2)
  
  priority       Int                 @default(0)
  
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  rule           SplitRule           @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId])
  @@index([priority])
  @@map("split_allocations")
}

// ============================================================================
// DUNNING - Cobrança de inadimplência
// ============================================================================

model DunningPolicy {
  id           String   @id @default(cuid())
  workspaceId  String
  
  name         String
  description  String?
  
  maxAttempts  Int      @default(3)
  intervalDays Int      @default(7)
  
  // Array de ações: { step: 1, action: "email", delay: 0 }, ...
  actions      Json
  
  isActive     Boolean  @default(true)
  isDefault    Boolean  @default(false)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workspace    Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  jobs         DunningJob[]

  @@index([workspaceId])
  @@index([isActive])
  @@map("dunning_policies")
}

model DunningJob {
  id            String           @id @default(cuid())
  workspaceId   String
  policyId      String
  invoiceId     String
  
  status        DunningJobStatus @default(PENDING)
  
  attemptNumber Int
  maxAttempts   Int
  
  scheduledAt   DateTime
  executedAt    DateTime?
  nextAttemptAt DateTime?
  
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  policy        DunningPolicy    @relation(fields: [policyId], references: [id])
  invoice       Invoice          @relation(fields: [invoiceId], references: [id])
  logs          DunningLog[]

  @@index([workspaceId])
  @@index([policyId])
  @@index([invoiceId])
  @@index([status])
  @@index([scheduledAt])
  @@map("dunning_jobs")
}

model DunningLog {
  id           String           @id @default(cuid())
  jobId        String
  
  action       DunningAction
  status       DunningLogStatus @default(PENDING)
  success      Boolean
  errorMessage String?
  
  metadata     Json?
  
  executedAt   DateTime         @default(now())
  createdAt    DateTime         @default(now())

  job          DunningJob       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([status])
  @@index([executedAt])
  @@map("dunning_logs")
}

// ============================================================================
// COMMUNICATIONS
// ============================================================================

model MessageTemplate {
  id          String              @id @default(cuid())
  workspaceId String
  
  name        String
  code        String
  type        MessageTemplateType
  
  subject     String?
  body        String
  
  channels    String[]            // ["email", "whatsapp"]
  
  isActive    Boolean             @default(true)
  deletedAt   DateTime?
  
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  workspace   Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, code])
  @@index([workspaceId])
  @@index([code])
  @@index([type])
  @@map("message_templates")
}

model Notification {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String?
  
  title       String
  message     String
  
  type        NotificationType @default(INFO)
  actionLabel String?
  actionUrl   String?
  
  isRead      Boolean   @default(false)
  readAt      DateTime?
  
  expiresAt   DateTime?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([userId])
  @@index([isRead])
  @@index([expiresAt])
  @@map("notifications")
}

// ============================================================================
// ANALYTICS & AUDIT
// ============================================================================

model AnalyticsEvent {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String?
  
  eventType   String
  entityType  String?
  entityId    String?
  
  properties  Json     @default("{}")
  
  createdAt   DateTime @default(now())

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([eventType])
  @@index([createdAt])
  @@map("analytics_events")
}

model AnalyticsMetric {
  id          String   @id @default(cuid())
  workspaceId String
  
  metricType  String
  period      String
  periodDate  DateTime
  
  value       Decimal  @db.Decimal(15, 2)
  metadata    Json?
  
  createdAt   DateTime @default(now())

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, metricType, period, periodDate])
  @@index([workspaceId])
  @@index([metricType])
  @@index([periodDate])
  @@map("analytics_metrics")
}

model AuditLog {
  id          String   @id @default(cuid())
  workspaceId String?
  userId      String?
  
  action      String
  entityType  String
  entityId    String?
  
  changes     Json?    // { field: { before: old, after: new } }
  metadata    Json?    // Dados adicionais
  
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User?     @relation("AuditLogUser", fields: [userId], references: [id])

  @@index([workspaceId])
  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// CONFIGURATION HISTORY - Versionamento de configurações
// ============================================================================

model ConfigHistory {
  id          String   @id @default(cuid())
  workspaceId String
  
  configType  String   // "WORKSPACE", "THEME", "MODULE", "FEATURE"
  configId    String   // ID da configuração alterada
  
  previousVal Json     // Valor anterior
  newVal      Json     // Novo valor
  
  changedBy   String?
  reason      String?  // Por que mudou?
  
  createdAt   DateTime @default(now())

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([configType])
  @@index([configId])
  @@index([createdAt])
  @@map("config_history")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserStatus {
  ACTIVE
  BLOCKED
  DELETED
}

enum WorkspaceType {
  SINGLE_BUSINESS
  FRANCHISE
}

enum WorkspaceCategory {
  DELIVERY
  AUTONOMO
  COMERCIO
  LOJA
  SERVICOS
  CONSTRUCAO
  LIVRE
}

enum WorkspaceStatus {
  ACTIVE
  SUSPENDED
  ARCHIVED
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MANAGER
  OPERATOR
  VIEWER
}

enum WorkspacePlan {
  FREE
  PRO
  ENTERPRISE
}

enum EnterpriseType {
  AUTONOMO
  EMPRESA
}

enum EnterpriseDocumentType {
  CPF
  CNPJ
  NONE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
  TRIALING
}

enum BillingCycle {
  MONTHLY
  YEARLY
  LIFETIME
}

enum WalletTransactionType {
  ONBOARDING_BONUS
  PLAN_REWARD
  PROMOTION
  EXTENSION_PURCHASE
  AI_CONSUMPTION
  MANUAL_CREDIT
  MANUAL_DEBIT
}

enum FeatureCategory {
  CORE
  AI
  AUTOMATION
  UI
  INTEGRATION
}

enum FeatureSource {
  PLAN
  STORE
  PROMOTION
  ONBOARDING
}

enum ThemeUIType {
  SYSTEM
  TEMPLATE
  CUSTOM
}

enum CustomerDocumentType {
  CPF
  CNPJ
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
  FAILED
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  PIX
  BANK_TRANSFER
  DAS
  OTHER
}

enum BankAccountType {
  CHECKING
  SAVINGS
}

enum BankTransactionType {
  DEBIT
  CREDIT
}

enum PixKeyType {
  CPF
  CNPJ
  EMAIL
  PHONE
  RANDOM
}

enum PixPaymentStatus {
  PENDING
  CREATED
  PROCESSING
  COMPLETED
  EXPIRED
  CANCELLED
  FAILED
}

enum DasPaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentLinkStatus {
  ACTIVE
  INACTIVE
  EXPIRED
}

enum SplitRecipientType {
  PIX_KEY
  BANK_ACCOUNT
  EXTERNAL_ID
}

enum SplitAllocationType {
  PERCENTAGE
  FIXED
}

enum VirtualAccountStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ModuleCategory {
  SALES
  INVENTORY
  FINANCE
  CRM
  ACCOUNTING
  REPORTS
  INTEGRATIONS
  OTHER
}

enum DunningJobStatus {
  PENDING
  SCHEDULED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum DunningLogStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
}

enum DunningAction {
  EMAIL
  SMS
  WHATSAPP
  NOTIFICATION
}

enum MessageTemplateType {
  EMAIL
  SMS
  WHATSAPP
  NOTIFICATION
  INVOICE
  ORDER
  QUOTE
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
}

enum PipelineEventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum WaitlistEntryStatus {
  PENDING
  NOTIFIED
  CONVERTED
}

// ============================================================================
// WAITLIST
// ============================================================================

model WaitlistEntry {
  id         String              @id @default(cuid())
  email      String              @unique @db.Citext
  status     WaitlistEntryStatus @default(PENDING)
  notifiedAt DateTime?
  metadata   Json?
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("waitlist_entries")
}